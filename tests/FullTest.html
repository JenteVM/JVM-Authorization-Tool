<!-- 
  NOTE: This file was fully generated by AI (ChatGPT).
  For testing purposes only.
-->

<!DOCTYPE html>
<html>
<head>
  <title>Full Test Console</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.5;
      background-color: #ffffff;
      color: #000000;
      transition: background 0.3s, color 0.3s;
    }
    form {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      background: #f9f9f9;
      transition: background 0.3s, border-color 0.3s;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    label {
      font-weight: bold;
    }
    input, select {
      margin-bottom: 10px;
      width: 100%;
      padding: 6px;
    }
    button {
      cursor: pointer;
    }
    .section {
      margin-bottom: 25px;
    }
    .section.collapsible > h2 {
      cursor: pointer;
      background: #eee;
      padding: 10px;
      border-radius: 6px;
    }
    .section.collapsible .content {
      display: none;
      margin-top: 10px;
    }
    .section.collapsible.open .content {
      display: block;
    }
    #authStatus {
      padding: 10px;
      font-weight: bold;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    #authStatus.not-auth {
      background-color: #ffd6d6;
      color: #b30000;
    }
    #authStatus.auth {
      background-color: #d6ffd6;
      color: #006600;
    }
    #logoutBtn, #validateBtn, #copyBtn, #darkModeBtn {
      margin-left: 10px;
      padding: 5px 10px;
    }
    #output {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      background: #fafafa;
      border-radius: 6px;
      max-height: 400px;
      overflow-y: auto;
      transition: background 0.3s, border-color 0.3s;
    }
    pre {
      margin: 0;
      font-family: monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* ---- DARK MODE ---- */
    body.dark {
      background-color: #1e1e1e;
      color: #e0e0e0;
    }
    body.dark form {
      background: #2b2b2b;
      border-color: #444;
    }
    body.dark .section.collapsible > h2 {
      background: #333;
    }
    body.dark #output {
      background: #2b2b2b;
      border-color: #444;
    }
    body.dark #authStatus.not-auth {
      background-color: #5c2b2b;
      color: #ffaaaa;
    }
    body.dark #authStatus.auth {
      background-color: #2b5c2b;
      color: #aaffaa;
    }
  </style>
</head>
<body>


  <!-- Authorization Status (moved to very top) -->
  <div id="authStatus" class="not-auth">
    üî¥ Not Authorized
  </div>

  <h1>
    Full Test Console 
    <button id="darkModeBtn" onclick="toggleDarkMode()">üåô Dark Mode</button>
  </h1>

  <p>Use these forms to test backend API endpoints. Each section corresponds to registry or user actions.</p>

  <!-- Registry Section -->
  <div class="section collapsible" id="registrySection">
    <h2>Registry Management</h2>
    <div class="content">

  <form id="registryForm" onsubmit="createRegistry(event); return false;">
        <h3>Create New Registry</h3>
        <label>App Name:</label>
        <input id="appName" type="text" required>
        <input type="submit" value="Create Registry">
      </form>

  <form id="lookupRegistryForm" onsubmit="lookupRegistry(event); return false;">
        <h3>Lookup Registry</h3>
        <label>Database ID:</label>
        <input id="lookupDbId" type="text" required>
        <input type="submit" value="Lookup Registry">
      </form>

  <form id="authRegistryForm" onsubmit="authenticateRegistry(event); return false;">
        <h3>Registry Authentication (Allowed Origins)</h3>
        <label>Database ID:</label>
        <input id="authDbId" type="text" required>
        <label>Registry Token:</label>
        <input id="registryToken" type="text" required>
        <input type="submit" value="Authenticate Registry">
      </form>

    </div>
  </div>

  <!-- User Section -->
  <div class="section collapsible" id="userSection">
    <h2>User Management</h2>
    <div class="content">

  <form id="userForm" onsubmit="sendUserRequest(event); return false;">
        <h3>User CRUD Operations</h3>
        <label>Target Database ID:</label>
        <input id="dbId" type="text" required>

        <label>Identifier (username/email for GET/DELETE/PATCH):</label>
        <input id="identifier" type="text">

        <label>Identifier Method:</label>
        <select id="idMethod">
          <option value="username">Username</option>
          <option value="email">Email</option>
        </select>

        <label>New Username:</label>
        <input id="username" type="text">

        <label>Email:</label>
        <input id="email" type="email">

        <label>Password:</label>
        <input id="password" type="password">

        <label>Auth Level:</label>
        <select id="authLevel">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>

        <label>Action:</label>
        <select id="requestType">
          <option value="GET">GET (List or Lookup)</option>
          <option value="POST">POST (Create)</option>
          <option value="PATCH">PATCH (Update)</option>
          <option value="DELETE">DELETE (Remove)</option>
        </select>

        <input type="submit" value="Submit User Request">
      </form>

  <form id="authForm" onsubmit="authenticateUser(event); return false;">
        <h3>User Authentication</h3>
        <label>Target Database ID:</label>
        <input id="authDbIdUsers" type="text" required>

        <label>Username or Email:</label>
        <input id="usernameOrEmail" type="text" required>

        <label>Password:</label>
        <input id="authPassword" type="password" required>

        <label>Time Extension (minutes):</label>
        <input id="timeExtension" type="number" value="30" required>

        <input type="submit" value="Authenticate User">
      </form>

    </div>
  </div>

  <!-- Output area -->
  <h2>Response Output</h2>
  <div id="output"><pre>Responses will appear here...</pre></div>

<script>
const apiBase = "https://didactic-space-palm-tree-v6gw94rjqw6p3wp5v-5000.app.github.dev/"; // adjust to your API host

// DARK MODE
function toggleDarkMode() {
  document.body.classList.toggle("dark");
  const darkEnabled = document.body.classList.contains("dark");
  localStorage.setItem("darkMode", darkEnabled ? "1" : "0");
  document.getElementById("darkModeBtn").textContent = darkEnabled ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
}
function initDarkMode() {
  const saved = localStorage.getItem("darkMode");
  if (saved === "1") {
    document.body.classList.add("dark");
    document.getElementById("darkModeBtn").textContent = "‚òÄÔ∏è Light Mode";
  }
}

// OUTPUT
function showOutput(title, data) {
  const out = document.getElementById("output");
  out.innerHTML = "<pre>" + title + "\n" + JSON.stringify(data, null, 2) + "</pre>";
}
function formatTime(date) { return date.toLocaleString(); }

// AUTH STATUS
function updateAuthStatus() {
  const token = localStorage.getItem("authToken");
  const dbId = localStorage.getItem("lastDbId");
  const lastValidated = localStorage.getItem("lastValidated");
  const statusDiv = document.getElementById("authStatus");

  if (token && dbId) {
    let html = "üü¢ Authorized<br>Token: " + token +
      " <button id='copyBtn' onclick='copyToken()'>üìã Copy</button>" +
      "<br>DB: " + dbId +
      "<button id='logoutBtn' onclick='logout()'>Logout</button>" +
      "<button id='validateBtn' onclick='validateToken()'>Validate Token</button>";
    if (lastValidated) html += "<br><i>Last validated: " + lastValidated + "</i>";
    statusDiv.innerHTML = html;
    statusDiv.className = "auth";
    autoFillDbId(dbId);
  } else {
    let msg = "üî¥ Not Authorized";
    if (window._showUnauthMsg) msg += "<br><b>You have been logged out or your session expired.</b>";
    statusDiv.innerHTML = msg;
    statusDiv.className = "not-auth";
    window._showUnauthMsg = false;
  }
}
function logout() {
  localStorage.removeItem("authToken");
  localStorage.removeItem("lastDbId");
  localStorage.removeItem("lastValidated");
  window._showUnauthMsg = true;
  updateAuthStatus();
}
function copyToken() {
  const token = localStorage.getItem("authToken");
  if (token) { navigator.clipboard.writeText(token); alert("Token copied!"); }
}

// VALIDATE TOKEN
function validateToken() {
  const token = localStorage.getItem("authToken");
  const dbId = localStorage.getItem("lastDbId");
  if (!token || !dbId) {
    showOutput("Validation Error", {error: "Missing token or database ID."});
    return;
  }
  const url = apiBase + "api/" + dbId + "/users/authenticate/2/" + token + "/";
  const userId = localStorage.getItem("userId") || "";
  fetch(url, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({user_id: userId}) })
    .then(res => res.json())
    .then(data => {
      if (data && data.auth_token) {
        showOutput("Token Validation Result", data);
        localStorage.setItem("authToken", data.auth_token); // <-- update token on reauth
        localStorage.setItem("lastValidated", formatTime(new Date()));
        if (data.user_id) localStorage.setItem("userId", data.user_id);
        updateAuthStatus();
      } else {
        logout();
        showOutput("Validation Error", {error: "Token invalid or expired."});
      }
    })
    .catch(err => { logout(); showOutput("Validation Error", {error: err}); });
}

// REGISTRY
function createRegistry(event) {
  if (event) event.preventDefault();
  const appName = document.getElementById("appName").value;
  fetch(apiBase + "api/registry/", {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify({app_name:appName})
  }).then(res=>res.json()).then(d=>showOutput("Registry Created",d))
  .catch(err=>showOutput("Registry Error",{error:err}));
}
function lookupRegistry(event) {
  if (event) event.preventDefault();
  const dbId = document.getElementById("lookupDbId").value;
  fetch(apiBase + "api/registry/"+dbId+"/", {method:"GET"})
  .then(res=>res.json()).then(d=>showOutput("Registry Lookup",d))
  .catch(err=>showOutput("Lookup Error",{error:err}));
}
function authenticateRegistry(event) {
  if (event) event.preventDefault();
  const dbId = document.getElementById("authDbId").value;
  const token = document.getElementById("registryToken").value;
  fetch(apiBase+"api/registry/authenticate/"+dbId+"/"+token+"/", {
    method:"GET", headers: {"Origin":window.location.origin}
  }).then(res=>res.json()).then(d=>showOutput("Registry Auth",d))
  .catch(err=>showOutput("Registry Auth Error",{error:err}));
}

// USERS CRUD
function sendUserRequest(event) {
  if (event) event.preventDefault();
  const dbId = document.getElementById("dbId").value;
  const identifier = document.getElementById("identifier").value;
  const idMethod = document.getElementById("idMethod").value;
  const username = document.getElementById("username").value;
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const authLevel = document.getElementById("authLevel").value;
  const requestType = document.getElementById("requestType").value;
  const token = localStorage.getItem("authToken");

  const usersBase = apiBase + "api/" + dbId + "/users/";
  const headers = { "Content-Type": "application/json" };
  if (token) headers["Authorization"] = "Bearer " + token;

  const userData = { username, email, password, auth_level: authLevel };

  if (requestType === "GET") {
    let url = usersBase;
    if (identifier) url += idMethod + "/" + identifier + "/";
    fetch(url, { method: "GET", headers })
      .then(res=>res.json()).then(d=>showOutput("GET Result",d))
      .catch(err=>showOutput("GET Error",{error:err}));
  }
  if (requestType === "POST") {
    fetch(usersBase,{method:"POST",headers,body:JSON.stringify(userData)})
      .then(res=>res.json()).then(d=>showOutput("User Created",d))
      .catch(err=>showOutput("POST Error",{error:err}));
  }
  if (requestType === "PATCH") {
    fetch(usersBase+idMethod+"/"+identifier+"/",{method:"PATCH",headers,body:JSON.stringify(userData)})
      .then(res=>res.json()).then(d=>showOutput("User Updated",d))
      .catch(err=>showOutput("PATCH Error",{error:err}));
  }
  if (requestType === "DELETE") {
    fetch(usersBase+idMethod+"/"+identifier+"/",{method:"DELETE",headers})
      .then(res=>res.json()).then(d=>showOutput("User Deleted",d))
      .catch(err=>showOutput("DELETE Error",{error:err}));
  }
}

// USER AUTH
function authenticateUser(event) {
  if (event) event.preventDefault();
  const dbId = document.getElementById("authDbIdUsers").value;
  const usernameOrEmail = document.getElementById("usernameOrEmail").value;
  const password = document.getElementById("authPassword").value;
  const timeExtension = document.getElementById("timeExtension").value;

  const url = apiBase + "api/" + dbId + "/users/authenticate/" + timeExtension + "/0/";

  const body = { username_or_email: usernameOrEmail, password: password };

  fetch(url, {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  }).then(res=>res.json()).then(data=>{
    if (data && data.auth_token) {
      showOutput("User Auth", data);
      localStorage.setItem("authToken", data.auth_token);
      localStorage.setItem("lastDbId", dbId);
      localStorage.setItem("lastValidated", formatTime(new Date()));
      if (data.user_id) localStorage.setItem("userId", data.user_id);
      updateAuthStatus();
    } else {
      logout();
      showOutput("Auth Error", {error: "Invalid credentials or token."});
    }
  }).catch(err=>{ logout(); showOutput("Auth Error",{error:err}); });

function reauthFromUserFields() {
  authenticateUser();
}
}

// QoL
function autoFillDbId(dbId) {
  if (dbId) {
    ["dbId","authDbIdUsers","lookupDbId","authDbId"].forEach(id=>{
      const el=document.getElementById(id);
      if(el && !el.value) el.value=dbId;
    });
  }
}
function setupCollapsibles() {
  document.querySelectorAll(".collapsible > h2").forEach(h2=>{
    h2.addEventListener("click", ()=>h2.parentElement.classList.toggle("open"));
  });
}

// INIT
setupCollapsibles();
updateAuthStatus();
initDarkMode();
// Alleen automatisch valideren als laatste validatie >5 min geleden is
const authToken = localStorage.getItem("authToken");
const lastValidated = localStorage.getItem("lastValidated");
let shouldValidate = false;
if (authToken) {
  if (lastValidated) {
    const last = new Date(lastValidated).getTime();
    const now = Date.now();
    // 5 minuten = 300000 ms
    if (now - last > 300000) shouldValidate = true;
  } else {
    shouldValidate = true;
  }
}
if (shouldValidate) validateToken();
</script>
</body>
</html>